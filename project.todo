LumOn Functional Test Coverage:

  Phase 4 - High Priority Missing Tests:
    Probe Trace Shaders (SH & Screen-Probe Atlas):
      ✔ RayHit_ReturnsSceneColor - Verify actual geometry hits return scene color (not just sky miss) @done
      ✔ DistanceFalloff_AppliedToHitRadiance - Test distance attenuation on hit radiance @done
      ✔ RaySteps_AffectsTraceQuality - Verify step count effect on ray march quality @done
      ✔ SunContribution_AddedToSkyMiss - Test sunDir/sunColor contribution to sky @done
      ✔ IndirectTint_AppliedToHitRadiance - Test tint on hit radiance (not just sky) @done
    Temporal Shaders (SH & Screen-Probe Atlas):
      ✔ DepthRejection_TriggersAtThreshold - Test boundary at exact depthRejectThreshold @done
      ✔ NormalRejection_TriggersAtThreshold - Test boundary at exact normalRejectThreshold @done
      ✔ HistoryOutOfBounds_UsesCurrentFrame - Test UV reprojection bounds rejection @done
      ✔ NeighborhoodClamping_PreventsGhosting - Verify clamp effect on blended result @done
      ✔ InvalidProbe_OutputsCurrentWithZeroMeta - Explicit radiance passthrough for invalid probes @done
    Gather Shaders (SH & Screen-Probe Atlas):
      ✔ DepthSigma_AffectsWeightFalloff - Test depthSigma uniform on weight calculation @done
      ✔ NormalSigma_AffectsWeightFalloff - Test normalSigma uniform on weight calculation @done
      ✔ EdgeProbe_ReducedWeight - Test partial validity (0.5) weight reduction @done
      ✔ AllProbesInvalid_OutputsZero - Verify totalWeight < 0.001 case @done

  Phase 5 - Medium Priority Missing Tests:
    Probe Trace Shaders:
      ✔ FrameIndex_JittersTexelSelection - Test multi-frame jitter pattern @done
      ✔ TexelsPerFrame_AffectsTemporalDistribution - Test different temporal distribution values @done
      ✔ RayExitsScreen_TerminatesEarly - Test ray leaving screen boundary @done
      ✔ InvViewMatrix_TransformsDirectionsCorrectly - Verify world-to-view transform accuracy @done
    Temporal Screen-Probe Atlas Shader:
      ✔ HitDistanceRejectThreshold_TriggersDisocclusion - Test threshold boundary behavior @done
      ✔ NeighborhoodClamping_ClampsToBounds - Verify specific clamp min/max behavior @done
      ✔ ZeroHistoryHitDistance_RejectedAsInvalid - Test near-zero history detection @done
    Gather Screen-Probe Atlas Shader:
      ✔ SampleStride_AffectsQuality - Test stride 1 vs 2 quality difference @done
      ✔ LeakThreshold_PreventsBleeding - Test leak prevention logic @done
      ✔ HemisphereBackface_SkippedCorrectly - Test cosWeight <= 0.0 rejection @done
    Upsample Shader:
      ✔ DenoiseDisabled_UsesSimpleBilinear - Test denoiseEnabled=0 fast path @done
      ✔ SpatialSigma_AffectsDenoising - Test upsampleSpatialSigma uniform @done
      ✔ DepthEdge_ReducesCrossBlending - Test bilateral filter at sharp depth edges @done
    Combine Shader:
      ✔ IndirectTint_ColorsIndirectLight - Test indirectTint uniform application @done
      ✔ PartialMetallic_BlendsDiffuse - Test mid-range metallic (0.5) behavior @done
    Debug Shader - Untested Modes:
      ✔ Mode3_ProbeNormals - Test renderProbeNormalDebug() @done
      ✔ Mode6_TemporalWeight - Test renderTemporalWeightDebug() @done
      ✔ Mode7_TemporalRejection - Test renderTemporalRejectionDebug() @done
      ✔ Mode9_InterpolationWeights - Test renderInterpolationWeightsDebug() @done

  Phase 6 - Low Priority Missing Tests:
    Error Handling & Edge Cases:
      ✔ ZeroRaysPerProbe_HandledGracefully - Edge case: 0 rays per probe @done
      ✔ ZeroTemporalAlpha_PassesThroughCurrent - Edge case: α=0 passthrough @done
      ✔ ZeroBilinearWeight_HandledCorrectly - Edge case: pixel at exact grid corner @done
      ✔ HalfResSmallerThanExpected_HandledGracefully - Buffer size mismatch @done
      ✔ NaNInput_ProducesValidOutput - Numeric stability with NaN inputs @done

  LumOn → Lumen Alignment Work (Screen-Space Pipeline)

    Reference:
    - docs/LumOn.08-Pipeline-Alignment-with-Lumen.md (Section 6 target pipeline)

    Dependency order notes:
    - Pass 0 (HZB) modifies the tracer, so if we do it, do it before adding confidence + temporal/filter tuning.
    - Confidence must exist before: temporal-confidence blending, probe-space filtering, and cheaper gather projections.
    - Probe-space filtering must exist before any gather path that assumes "stable" probe radiance.

    Target pipeline:
      0. (New) Depth pyramid / HZB (optional, recommended)
      1. Probe Anchor (with jitter)
      2. Screen-Probe Atlas Trace (radiance + hitdist + meta)
      3. Screen-Probe Atlas Temporal (expanded to use meta)
      3.5 (New) Probe-space filter/denoise (edge-stopped)
      4. Gather (cheaper)
      5. Upsample (optional spatial denoise)
      6. Combine (optional)

    Phase 7 - Pass 1: Probe Anchor Jitter
    Exit artifacts: Probe anchor pass supports jitter (frameIndex plumbing + optional config toggles); probe anchors remain MRT posWS/normalWS.
    ✔ Add `frameIndex` uniform support to probe anchor program + plumbing from LumOnRenderer @done
    ✔ Implement sub-pixel / sub-cell jitter in lumon_probe_anchor.fsh probe sample UV @done
    ✔ Ensure jitter is deterministic per-frame and stable across screen resize (use existing `Squirrel3Hash` for deterministic jitter) @done
    ✔ Add config toggles/params (optional): EnableAnchorJitter, JitterScale @done
    ✔ Add debug visualization: show jittered sample locations (optional) @done
    ✔ Add GPU functional test: AnchorJitter_ChangesSampleLocation_Deterministically @done

    Phase 8 - Pass 0 (Optional/Recommended): Depth Pyramid / HZB
    Exit artifacts: Depth pyramid textures exist per frame; screen-probe tracer can consume HZB for traversal/refinement.
    ✔ Add depth pyramid builder:
      - generate mip chain from primaryDepth each frame
      - store as a set of textures or layered atlas @done
    ✔ Update lumon_probe_trace_octahedral.fsh to use HZB for faster/more robust hits
      - hierarchical stepping and/or binary refinement near hit @done
    ✔ Add GPU functional tests:
      - HZB_BuildProducesMonotonicDepthMips
      - Trace_HZBMatchesBaselineHitInSimpleScene @done

    Phase 9.0 - Naming/Refactor: Screen-Probe Atlas Terminology
    Exit artifacts: Public-facing names and file/class identifiers use “ScreenProbeAtlas” (or similar) instead of “Octahedral”, while octahedral remains an implementation detail for the mapping math.
    ✔ Define naming conventions: @done
      - Prefer “ScreenProbeAtlas” / “ProbeAtlas” for pipeline stages and textures
      - Keep “octahedral” only for mapping utilities (e.g., lumon_octahedral.glsl)
    ✔ Rename C# buffer/texture identifiers in LumOnBufferManager: @done
      - Octahedral*Tex* → ScreenProbeAtlas* (Trace/Current/History)
      - FBO fields similarly (Octahedral*Fbo → ScreenProbeAtlas*Fbo)
    ✔ Rename C# shader program classes / properties: @done
      - LumOnOctahedralTraceShaderProgram → LumOnScreenProbeAtlasTraceShaderProgram
      - LumOnTemporalOctahedralShaderProgram → LumOnScreenProbeAtlasTemporalShaderProgram
      - Any “OctahedralHistory/Current” uniform property names to “ProbeAtlas*” where appropriate
    ✔ Rename renderer pass methods/labels: @done
      - RenderOctahedralTrace / RenderOctahedralTemporal → RenderProbeAtlasTrace / RenderProbeAtlasTemporal
      - Debug mode names updated to “ProbeAtlas*”
    ✔ Rename GPU tests (class + filenames) to match pipeline naming: @done
      - *Octahedral*Tests → *ProbeAtlas*Tests (keep shader filenames unchanged initially)
    ✔ Rename shader filenames after plumbing is stable: @done
      - lumon_probe_trace_octahedral.* → lumon_probe_atlas_trace.*
      - lumon_temporal_octahedral.* → lumon_probe_atlas_temporal.*
      - lumon_gather_octahedral.* → lumon_probe_atlas_gather.*
      - Keep the mapping include named lumon_octahedral.glsl
    ✔ Update references/asset copy rules for renamed shader files (tests csproj content include patterns) @done
    ✔ Verify: build + GPU tests still pass after renames @done

    Phase 9 - Pass 2: Screen-Probe Atlas Meta Output
    Exit artifacts: Screen-probe trace outputs radiance/hitdist plus meta (confidence + bitflags); history preservation applies to meta too.
    ✔ Decide meta storage: @done
      - Add a second atlas texture attachment: RG32F (R=confidence, G=uintBitsToFloat(flags))
      - Shared include: define bit flags + pack/unpack helpers in a .glsl include (e.g., lumon_probe_atlas_meta.glsl)
    ✔ Add shader include: lumon_probe_atlas_meta.glsl @done
      - const uint flags (Hit, SkyMiss, ScreenExit, EarlyTerminated, ThicknessUncertain, etc.)
      - vec2 EncodeMeta(float confidence, uint flags)
      - void DecodeMeta(vec2 meta, out float confidence, out uint flags)
    ✔ Update LumOnBufferManager: @done
      - allocate ScreenProbeAtlasMetaTraceTex (+ FBO attachment)
      - allocate ScreenProbeAtlasMetaCurrentTex / ScreenProbeAtlasMetaHistoryTex (for temporal/history)
    ✔ Update shader program bindings + renderer pass wiring: @done
      - trace pass writes MRT (radiance+hitdist, meta)
      - bind meta history input to trace pass so non-traced texels preserve history
    ✔ Update lumon_probe_atlas_trace.fsh (implementation detail: octahedral mapping): @done
      - compute meta for traced texels (hit vs sky, early exit, thickness margin)
      - output meta for traced texels
      - preserve meta history for non-traced texels (like radiance)
    ✔ Add GPU functional tests: @done
      - Meta_HitHigherThanSky
      - Meta_RayExitsScreen_LowerConfidence
      - Meta_NonTracedTexels_PreserveHistory

    Phase 10 - Pass 3: Screen-Probe Atlas Temporal Uses Meta
    Exit artifacts: Screen-probe atlas temporal produces meta-aware stabilized atlases suitable for downstream filtering/gather.
    ✔ Update lumon_probe_atlas_temporal.fsh (implementation detail: octahedral mapping) to read/write meta (separate texture) @done
    ✔ Make temporal alpha adaptive using meta confidence (e.g., alpha *= historyConfidence) @done
    ✔ Make disocclusion/invalid-history decisions consider confidence/flags (not just hit distance) @done
    ✔ Add debug mode: MetaConfidence / TemporalAlpha visualization @done
    ✔ Add GPU functional tests: @done
      - Temporal_MetaReducesHistoryWeight @done
      - Temporal_LowConfidence_ForcesReset @done

    Phase 11 - Pass 3.5: Probe-Space Filter/Denoise (New)
    Exit artifacts: Filtered atlas exists (radiance/hitdist/confidence as applicable); renderer can choose raw vs filtered as gather input.
    ☐ Add new shader + program: lumon_probe_atlas_filter.fsh (edge-stopped)
    ☐ Update LumOnBufferManager:
      - allocate filtered atlas (radiance + hitdist + confidence as needed)
      - create filter FBOs
    ☐ Update LumOnRenderer orchestration: insert Pass 3.5 between temporal and gather
    ☐ Implement filtering strategy (start simple, then expand if needed):
      - Angular (within-tile) 3x3 or 5x5 filter with hitdist/confidence weights
      - Optional: spatial (between-probe) filter for same oct texel across neighboring probes
    ☐ Add GPU functional tests:
      - Filter_ReducesNoise_PreservesEdges
      - Filter_RespectsInvalidProbes
      - Filter_RespectsConfidence

    Phase 12 - Pass 4: Cheaper Gather Options
    Exit artifacts: Gather has a defined “cheap” mode (stride/fewer dirs) and/or a projected-basis path (if implemented) selectable via config.
    ☐ Decide gather simplification path:
      - Option A (minimal): keep atlas gather but enforce/sample lower cost by default (stride, fewer dirs)
      - Option B (Lumen-like): add atlas → irradiance basis conversion pass, then gather is cheap
    ☐ Update config:
      ☐ Select gather mode: IntegrateAtlas vs EvaluateProjectedSH
    ☐ If Option B:
      ☐ Add new pass: atlas → SH projection (per-probe SH3/SH9) after temporal+filter
      ☐ Add per-probe SH textures + program + buffer manager allocations
      ☐ Add gather shader variant that evaluates SH at pixel normal
    ☐ Add GPU functional tests:
      - AtlasToSH_ProjectsKnownAtlasCorrectly
      - Gather_SHFromProjected_StableVsIntegration

    Phase 13 - Integration, Debug, and Performance
    Exit artifacts: New passes are debuggable and timed; perf baselines documented; optional minimal visual regression hooks exist.
    ☐ Add debug modes for:
      - screen-probe atlas meta
      - filtered atlas visualization (probe-space)
      - gather input selection (raw vs filtered)
    ☐ Extend GPU timer queries to include new passes (HZB, Filter, Projection)
    ☐ Add quick performance benchmarks and document typical costs in docs
    ☐ Add minimal visual regression hooks (deferred if too heavy)

    Phase 14 - Screen-Space Parity/Polish (Remaining Discrepancies)
    Depends on: Phase 9 (confidence), Phase 10 (temporal uses confidence), Phase 11 (probe-space filter).
    Exit artifacts: Screen-space GI is more Lumen-like in stability/robustness (exposure-stable, fewer edge holes, fewer temporal fireflies), with tests/diagnostics.
    ☐ Reprojection inputs (motion vectors / camera motion):
      - Determine whether VS exposes motion vectors or equivalent per-pixel velocity
      - If available: incorporate into temporal rejection/weighting for gather/upsample (and/or probe updates)
      - If not available: implement a best-effort camera-motion heuristic path (rotation/translation gating)
    ☐ Exposure / color space consistency:
      - Verify whether CapturedSceneTex is pre- or post-tonemap (and whether exposure changes frame-to-frame)
      - If exposure varies: add pre-exposure compensation or capture an untonemapped buffer if available
      - Add a debug view to compare captured scene vs expected linear lighting space
    ☐ Variance / moments for temporal stability:
      - Add optional moments buffer (e.g., first/second moment of radiance) for the probe atlas or for indirectHalf
      - Use it for variance clamp/firefly suppression in temporal and/or post-filter
    ☐ Screen-trace hole filling strategy:
      - Add a controlled neighborhood resolve for rays that exit screen / miss due to disocclusion
      - Use confidence to avoid smearing across depth/normal edges
      - Ensure this is a bounded fallback (never overrides high-confidence hits)
    ☐ Sky visibility / sky-occlusion term (screen-space approximation):
      - Add an optional, cheap sky-visibility estimate (screen-space only) to reduce overly bright indoor skylight
      - Keep it explicitly marked as screen-space approximation (no world proxy)
    ☐ Add GPU functional tests:
      - ExposureChange_DoesNotCauseTemporalPumping (or a reduced equivalent)
      - VarianceClamp_ReducesFireflies_PreservesMean
      - HoleFill_OnlyAffectsLowConfidenceAreas
      - SkyVisibility_ReducesIndoorSkylightWithoutBlackening
