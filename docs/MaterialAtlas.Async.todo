# MaterialAtlas Async Rework

Goals:
- Eliminate render-thread stalls during material atlas rebuilds.
- Keep deterministic outputs and cache behavior.
- Preserve current visual results across sync and async paths.

☑ Phase 0 - Baseline and guardrails
  ☑ Add profiling scopes around async scheduling and normal+depth bake.
  ☑ Capture cache hit/miss counts and cache read profiling scopes.

☑ Phase 1 - Move material params cache IO off the main thread
  ☑ Replace main-thread cache scan in StartMaterialParamsAsyncBuild with a CPU job that:
    ☑ Tries disk cache first.
    ☑ Falls back to procedural build on miss.
  ☑ Keep override behavior:
    ☑ If post-override cache hits, skip override upload.
    ☑ If override-only rects exist, enqueue override upload as today.
  ☑ Preserve cache stats logging (base/override hits and misses).

☐ Phase 2 - Budgeted normal+depth pipeline
  ☐ Introduce normal+depth GPU jobs executed via a per-frame budget.
  ☐ Track per-page "clear once" state before the first tile upload.
  ☐ Add normal+depth progress to async diagnostics and HUD.

☐ Phase 3 - Disk cache IO isolation
  ☐ Ensure normal+depth cache reads run on worker threads only.
  ☐ Keep cache writes off the render thread (Task.Run) and cancel-aware.
  ☐ Add bounded queues or backpressure to avoid memory spikes.

☐ Phase 4 - Config and UX
  ☐ Add config knobs for normal+depth async budget (ms) and max uploads/frame.
  ☐ Document new knobs and defaults in config docs and change notes.
  ☐ Update the progress panel to show material params vs normal+depth progress.

☐ Phase 5 - Validation and regression coverage
  ☐ Add tests for determinism and cache key stability when async is enabled.
  ☐ Add a perf checklist: rebuild time, max frame time spike, total tiles.
  ☐ Validate sync vs async output parity for a fixed atlas snapshot.
