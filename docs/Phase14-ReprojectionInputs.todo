Phase 14 - Reprojection Inputs (No Engine Motion Vectors)

Goal:
  Add robust temporal reprojection inputs to reduce ghosting/pumping and improve disocclusion handling.
  This phase assumes we do NOT have engine-provided motion vectors.

Approach:
  Primary: Reconstruct per-pixel screen-space velocity from depth + previous/current camera matrices.
  Fallback: Camera-motion heuristic gating (rotation/translation thresholds) if depth reconstruction is unreliable.

Non-goals (initial):
  - Per-object motion for entities (true skinned/object velocities)
  - Accurate motion in transparents/particles


Phase 14.1 - Audit + Contract Definition
Exit artifacts:
  - Clear, documented list of reprojection inputs (textures + uniforms) needed by temporal shaders.
  - A consistent velocity convention (UV delta per frame) used across passes.

Work items:
  ✔ Identify all temporal consumers that would benefit from motion (ProbeAtlasTemporal, UpsampleTemporal if applicable).
  ✔ Document existing reprojection inputs in each shader (prev/current matrices, depth, normals, hitdist/meta).
  ✔ Decide velocity representation:
      - vec2 velocityUv (currentUV - prevUV)
      - coordinate space (UV vs NDC) and Y direction conventions
  ✔ Define a shared include contract:
      - ComputePrevUvFromDepth(...)
      - ComputeVelocityUvFromDepth(...)
      - Helpers for bounds checks and NaN/inf safety


Phase 14.2 - Previous Frame Camera State Plumbing
Exit artifacts:
  - Renderer persists and updates previous-frame matrices reliably.
  - Temporal shaders can access prev/current matrices every frame.

Work items:
  ✔ Add persistent storage for previous camera matrices in the renderer (at minimum prevViewProj).
  ✔ Define update timing:
      - Ensure prev matrices represent the frame whose history textures were rendered.
      - Update prev matrices after completing the frame’s passes.
  ☐ Handle edge cases:
  ✔ Handle edge cases:
      - First frame: mark history invalid / force reset
      - Resizes: force reset and/or invalidate prev matrices
      - Camera teleports / large delta: optional force reset


Phase 14.3 - Velocity Reconstruction (Depth + Matrices)
Exit artifacts:
  - A deterministic, tested velocity reconstruction path usable by temporal shaders.
  - Reasonable behavior at depth discontinuities and invalid depth.

Work items:
  ✔ Confirm depth input format for reconstruction (primary depth texture, linear vs non-linear).
  ✔ Implement velocity reconstruction math:
      - Reconstruct world/view position from current depth + invCurrentViewProj
      - Project into previous clip space using prevViewProj
      - Convert to prevUV and compute velocityUv = currUV - prevUV
  ✔ Add robustness:
      - Guard against invalid depth (0/1 sentinel), NaN propagation
      - Clamp or mark invalid when prevW <= 0 or prevUV out of bounds
  ✔ Decide whether to store velocity in a texture (optional) vs compute on the fly in each pass.
    - Decision: allocate a dedicated velocity texture and store validity flags using uintBitsToFloat packing (like probe-atlas meta).


Phase 14.4 - Temporal Integration (Meta-Aware)
Exit artifacts:
  - Temporal reprojection uses velocity-based UVs and improves disocclusion decisions.
  - Reduced ghosting on camera movement vs matrix-only approximations.

Work items:
  ✔ Probe-grid Temporal (SH mode):
    - Use velocity-based prevUV to sample history (via VelocityTex + packed flags)
    - Improve out-of-bounds and invalid history rejection using velocity validity
    - Optionally scale temporal alpha by motion magnitude and existing confidence/meta
  ☐ Probe Atlas Temporal:
    - (N/A for now: atlas texels are in a stable atlas coordinate system; no screen-space reprojection)
  ✔ Any downstream temporal consumers (if present):
    - Apply same contract/inputs for consistent behavior
  ✔ Add config knobs (optional, but recommended):
      - EnableReprojectionVelocity
      - VelocityRejectThreshold (UV magnitude)
      - CameraTeleportResetThreshold (translation/rotation)


Phase 14.5 - Debug & Diagnostics
Exit artifacts:
  - Debug visualization modes for velocity and reprojection validity.

Work items:
  ✔ Debug view: velocity magnitude heatmap (|velocityUv| scaled)
  ✔ Debug view: reprojection validity mask (valid/invalid prevUV)
  ✔ Debug view: “history sample UV” visualization (optional)
  ✔ On-screen stats/logging for forced resets (resize/teleport)


Phase 14.6 - GPU Functional Tests
Exit artifacts:
  - Deterministic tests proving velocity reconstruction and temporal behavior.

Work items:
  ☐ Velocity_StaticCamera_IsZero:
      - With stable camera and scene, reconstructed velocity is ~0 in valid pixels
  ☐ Velocity_PureTranslation_ProducesExpectedDirection:
      - Translate camera right/left; verify sign/direction of velocity
  ☐ Velocity_PureRotation_ProducesExpectedPattern:
      - Rotate camera yaw; verify velocity magnitude increases toward screen edges
  ☐ Temporal_MotionImprovesHistoryStability:
      - Under controlled camera motion, verify fewer false rejections / less ghosting vs baseline
  ☐ Temporal_LargeDelta_ForcesReset:
      - Teleport or extreme rotation forces history invalidation


Phase 14.7 - Fallback Path (Camera-Motion Heuristic)
Exit artifacts:
  - If depth reconstruction fails for some reason, temporal stability still improves.

Work items:
  ☐ Implement heuristic gating:
      - Compute per-frame camera translation and rotation deltas
      - Scale temporal alpha down as deltas grow
      - Force reset past thresholds
  ☐ Add a config toggle to select fallback explicitly.


Phase 14.8 - Performance & Tuning
Exit artifacts:
  - Motion reprojection cost is measured and kept acceptable.
  - Default thresholds are reasonable across typical scenes.

Work items:
  ☐ Profile shader cost impact of velocity reconstruction.
  ☐ Consider caching velocity (optional) if multiple passes need it.
  ☐ Tune thresholds:
      - depth/normal reject thresholds interplay with velocity
      - confidence/meta scaling interplay with motion
  ☐ Document recommended defaults and caveats.
