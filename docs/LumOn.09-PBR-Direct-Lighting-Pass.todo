Phase 16 - PBR Direct Lighting Pass System (Opaque @ RenderOrder = 9.0)

  Reference design:
    - docs/LumOn.09-PBR-Direct-Lighting-Pass.md

  Core contract (decisions locked):
    - Direct lighting is authoritative and replaces pbr-overlay (overlay disabled; removal later)
    - Albedo/baseColor signal (Primary ColorAttachment0) is confirmed linear space
    - Outputs are split: DirectDiffuseTex + DirectSpecularTex + EmissiveTex (linear, pre-tonemap)
    - Fog is applied in final composite (direct pass outputs fog-free radiance)
    - All light sources are in scope (sun/sky, point lights, shadows, fog volumes, etc.)
    - Correct render stage: EnumRenderStage.Opaque, RenderOrder = 9.0

  Phase 16.0 - Contract Verification (Pre-Implementation)
  Exit artifacts: we know what every input/output means and how it is encoded.
    ✔ ColorAttachment0 is linear baseColor at Opaque stage (confirmed)
    ✔ Verify G-buffer encodings used by VGE
      - NormalTex (Attachment4): currently RGBA16F, packed normalWS = n*0.5+0.5, A=1.0
      - MaterialTex (Attachment5): currently RGBA8 with (R=roughness, G=metallic, B=emissive, A=reflectivity)
      - Planned: upgrade MaterialTex to RGBA16F for accuracy (Phase 16.1)
    ✔ Verify shadow-map accessibility for fullscreen file shader program
      - Accessible via capi.Render.FrameBuffers[(int)EnumFrameBuffer.ShadowmapNear/Far]
      - Shadow map texture id is expected to be FrameBufferRef.DepthTextureId (verify sampling conventions in Phase 16.2 when wiring the shader)
      - Matrix sources: DefaultShaderUniforms.ToShadowMapSpaceMatrixNear/Far
      - Range/params: ShadowRangeNear/Far, ShadowZExtendNear/Far, DropShadowIntensity
    ✔ Verify point light data surface
      - DefaultShaderUniforms.PointLightsCount / PointLights3 / PointLightColors3
      - Additional lighting-related textures/uniforms available via DefaultShaderUniforms:
        - SunPosition3D, LightPosition3D, SunSpecularIntensity
        - SunLightTextureId, GlowTextureId, SkyTextureId

  Phase 16.1 - Buffers & FBO Plumbing
  Exit artifacts: direct outputs exist and resize correctly, with an FBO ready for rendering.
    ✔ Add new buffer manager (or extend existing) allocations:
      - DirectDiffuseTex (HDR) - added in DirectLightingBufferManager.cs
      - DirectSpecularTex (HDR) - added in DirectLightingBufferManager.cs
      - EmissiveTex (HDR) - added in DirectLightingBufferManager.cs
    ✔ Choose concrete texture formats (RGBA16F for all three)
    ✔ Create DirectLightingFbo with MRT attachments for the three outputs
    ✔ Handle resize lifecycle consistently with existing buffer managers
      - EnsureBuffers() recreates on dimension change
    ✔ Add debug asserts/logs for FBO completeness
      - CheckFramebufferStatus + logging in CreateBuffers()

    ✔ Upgrade GBuffer MaterialTex format for precision
      - Changed MaterialTex (Attachment5) internal format to RGBA16F
      - Updated comments in GBufferManager, VanillaShaderPatches, PBROverlayShaderProgram, pbroverlay.fsh
      - Confirmed shader patch outputs vec4(roughness, metallic, emissive, reflectivity)

  Phase 16.2 - Shader Implementation (Full Metallic/Roughness BRDF)
  Exit artifacts: a new direct-lighting shader compiles and outputs correct split buffers.
    ✔ Add new shader program files:
      - assets/vanillagraphicsexpanded/shaders/pbr_direct_lighting.vsh
      - assets/vanillagraphicsexpanded/shaders/pbr_direct_lighting.fsh
    ✔ Shader inputs:
      - primaryScene (baseColor), primaryDepth
      - gBufferNormal (Attachment4), gBufferMaterial (Attachment5)
      - light inputs (directional + point lights, plus shadow-map uniforms stubbed for Phase 16.3 wiring)
    ✔ Implement BRDF:
      - GGX NDF, Smith geometry, Schlick Fresnel
      - Metallic workflow: F0 = mix(0.04 * reflectivity, baseColor, metallic)
      - Output split: directDiffuse, directSpecular (MRT locations 0/1)

    ✔ Shared PBR math source of truth
      - Reuses assets/vanillagraphicsexpanded/shaders/includes/pbr_common.glsl
      - No duplicated BRDF math in the pass shader beyond orchestration
    ✔ Emissive output:
      - Writes emissive separately to EmissiveTex (MRT location 2)
      - Does not mix emissive into diffuse/spec
    ✔ Apply no fog in this pass (fog applied in final composite)

  Phase 16.3 - C# ShaderProgram Wrapper + Registration
  Exit artifacts: shader is loadable/compilable and uniforms are bound via typed properties.
    ✔ Add PBR direct lighting shader program class (like PBROverlayShaderProgram)
      - Added PBRDirectLightingShaderProgram (typed uniforms + samplers)
      - Registered in VanillaGraphicsExpandedModSystem.LoadShaders()
    ✔ Ensure any required imports/includes are available via ShaderImportsSystem
      - ShaderImportsSystem is initialized in AssetsLoaded and supports @import preprocessing

  Phase 16.4 - Renderer Stage (Opaque @ 9.0)
  Exit artifacts: direct lighting runs every frame at the correct stage/order.
    ☐ Implement DirectLightingRenderer : IRenderer
      - Register at EnumRenderStage.Opaque with RenderOrder = 9.0
      - Fullscreen quad
      - Bind primary FBO textures + gbuffer textures
      - Bind direct lighting FBO MRT and draw
    ☐ Verify ordering:
      - Runs after opaque geometry has written MRT
      - Runs before downstream GI/combine stages

  Phase 16.5 - Composite Integration (Fog + Direct/Indirect Merge)
  Exit artifacts: final on-screen output uses new direct buffers; fog applied once.
    ☐ Update composite stage to use:
      - DirectDiffuseTex + DirectSpecularTex + EmissiveTex
      - + IndirectDiffuse/IndirectSpecular (when LumOn enabled)
    ☐ Apply fog in composite (using depth + fog uniforms)
    ☐ Ensure LumOn disabled path still produces correct direct+emissive output

  Phase 16.6 - Disable PBROverlay System
  Exit artifacts: pbr-overlay no longer runs and hotkey toggle is inert/unregistered.
    ☐ Stop registering PBROverlayRenderer in ModSystem
    ☐ Stop registering/compiling pbroverlay shader program (optional, but preferred)
    ☐ Remove hotkey handler registration for overlay toggle

  Phase 16.7 - Debug Views + Diagnostics
  Exit artifacts: new buffers are inspectable and timed.
    ☐ Add debug modes to visualize:
      - DirectDiffuseTex
      - DirectSpecularTex
      - EmissiveTex
      - Optional: DirectTotal (diffuse+spec) overlay
    ☐ Add GPU timing queries for the new direct pass

  Phase 16.8 - GPU Functional Tests
  Exit artifacts: deterministic tests validate BRDF split and emissive separation.
    ☐ Add tests:
      - DirectLighting_ProducesExpectedLambertForDielectric
      - DirectLighting_MetallicShiftsEnergyToSpecular
      - DirectLighting_EmissiveIsSeparateBuffer
      - DirectLighting_StableUnderCameraMotion
      - Integration_LumOnDisabled_PassesThroughDirect
    ☐ Ensure tests cover edge cases:
      - Roughness extremes (0, 1)
      - Metallic extremes (0, 1)
      - Emissive non-zero with no lights

  Phase 16.9 - Polish & Cleanup
  Exit artifacts: stable performance and clean handoff for removing overlay later.
    ☐ Document exact uniform/sampler bindings used by the direct pass
    ☐ Ensure no remaining runtime dependence on pbr-overlay
    ☐ Confirm performance budget (timers) and note baseline in docs
