Shader Define Migration (SetDefine) Work:

  Goal:
  Convert “constant-like” shader uniforms into compile-time defines using VGE’s `VgeShaderProgram.SetDefine()`
  so we reduce per-fragment branching, remove dead uniform plumbing, and centralize common feature gates.

  Notes:
  - Prefer defines for: feature toggles (0/1), rarely-changed mode switches, and loop bounds.
  - Keep runtime uniforms for: matrices, frameIndex/time, screen sizes, textures/samplers, fog, lighting arrays.
  - Any uniform → define change must include shader-side defaults via `#ifndef NAME` / `#define NAME <default>`.
  - When defines change at runtime, `SetDefine()` triggers a shader recompile (only on changes).

  Phase 0 - Audit / Inventory:
  Exit artifacts: A complete list of shader “constant-like” uniforms and a decision log of which become defines vs stay uniforms.
  ☑ Inventory all shader wrapper properties:
    - Scan `VanillaGraphicsExpanded/VanillaGraphicsExpanded/**/Shaders/*.cs`
    - Record uniform name, type, usage frequency (per-frame vs rare), and shaders affected
  ☑ Inventory all GLSL uniforms and their usage sites:
    - Scan `VanillaGraphicsExpanded/VanillaGraphicsExpanded/assets/vanillagraphicsexpanded/shaders/**/*.fsh/.vsh/.glsl`
    - Tag candidates: `int/bool` logic gates and values used as loop bounds
  ☑ Produce a “define candidate table” (source of truth):
    - C# property → GLSL uniform → shader files → proposed define name/value shape
  ☑ Produce a “must remain uniform” list (source of truth):
    - Matrices, textures, screenSize, frameIndex, fog, point lights, etc.

  Phase 0 output: `docs/ShaderDefines.SetDefineMigration.Phase0.md`

  Phase 1 - Define Naming Conventions + Global Include:
  Exit artifacts: A stable naming scheme and a shared include for defaults/conventions.
  ☑ Decide naming conventions:
    - Prefer `VGE_*` prefix for new global defines
    - Decide whether to keep or rename existing `LUMON_EMISSIVE_BOOST` (avoid churn unless needed)
  ☑ Add a global defines include (new):
    - `assets/vanillagraphicsexpanded/shaders/includes/vge_global_defines.glsl`
    - Contains: shared `#ifndef/#define` defaults for cross-pass toggles
  ☑ Decide which defines are “global” vs feature-specific:
    - Global: used by multiple shaders (LumOn + PBR composite)
    - Feature-specific: used by exactly one stage or one shader family
  ☑ Document usage pattern:
    - How to write shader code: `#if VGE_FOO` / `#ifdef VGE_FOO`
    - How to wire in C#: property setter calls `setDefine("VGE_FOO", "1")`

  Phase 1 outputs:
    - `VanillaGraphicsExpanded/VanillaGraphicsExpanded/assets/vanillagraphicsexpanded/shaders/includes/vge_global_defines.glsl`
    - `docs/ShaderDefines.SetDefineMigration.Phase1.md`

  Phase 2 - Test Infrastructure: Define Injection Support:
  Exit artifacts: GPU tests can compile shader variants with defines without relying on uniforms.
  ☑ Add define injection support to the GPU shader compile helper:
    - Update `VanillaGraphicsExpanded.Tests/GPU/Helpers/ShaderTestHelper.cs` (or equivalent)
    - Inject `#define` lines immediately after `#version` in the fully-processed source
  ☑ Add a small helper API for tests:
    - e.g., `CompileShaderWithDefines(vsh, fsh, Dictionary<string,string>)`
  ☑ Decide standard define serialization for tests:
    - ints as `"0"/"1"` or literal numbers
    - floats must be invariant literals (e.g., `"2.0"`)
  ☑ Update “uniform presence” tests:
    - `LumOnUniformTests` should stop asserting uniforms that become defines
    - Add a new test category: “critical defines present + defaulted” (shader compiles without injected defines)

  Phase 2 outputs:
    - `VanillaGraphicsExpanded.Tests/GPU/Helpers/ShaderTestHelper.cs`
    - `VanillaGraphicsExpanded.Tests/GPU/ShaderDefineInjectionTests.cs`
    - `VanillaGraphicsExpanded/assets/vanillagraphicsexpanded/shaders/tests/vge_global_defines_smoke.vsh`
    - `VanillaGraphicsExpanded/assets/vanillagraphicsexpanded/shaders/tests/vge_global_defines_smoke.fsh`

  Phase 3 - Convert Cross-Pass Toggles (LumOn + PBR Composite):
  Exit artifacts: Common toggles are defines and share defaults in the global include.
  ☑ Convert `lumOnEnabled`:
    - `lumon_combine.fsh` and `pbr_composite.fsh` use `#if VGE_LUMON_ENABLED`
    - Update shader program wrappers and renderers to call `SetDefine()`
  ☑ Convert `enablePbrComposite`, `enableAO`, `enableBentNormal`:
    - Define names:
      - `VGE_LUMON_PBR_COMPOSITE`
      - `VGE_LUMON_ENABLE_AO`
      - `VGE_LUMON_ENABLE_BENT_NORMAL`
    - Ensure defaults match existing behavior
  ☑ Update GPU integration tests that flip these toggles:
    - Compile two variants (define=0 vs define=1) and compare expected outputs

  Phase 3 outputs:
    - `assets/vanillagraphicsexpanded/shaders/lumon_combine.fsh` (import vge_global_defines.glsl, #if branches)
    - `assets/vanillagraphicsexpanded/shaders/pbr_composite.fsh` (import vge_global_defines.glsl, #if branches)
    - `assets/vanillagraphicsexpanded/shaders/lumon_debug.fsh` (import vge_global_defines.glsl, #if branches)
    - `LumOnCombineShaderProgram.cs`, `PBRCompositeShaderProgram.cs`, `LumOnDebugShaderProgram.cs` (SetDefine wiring)
    - `PBRCompositeRenderer.cs`, `LumOnDebugRenderer.cs` (bool-typed callers)
    - `ShaderDefineInjectionTests.cs` (variant compile tests)

  Phase 4 - Convert LumOn Upsample Toggles:
  Exit artifacts: Upsample denoise/holefill switches are defines, and tests cover both paths via compiled variants.
  ☑ Convert `denoiseEnabled` to `VGE_LUMON_UPSAMPLE_DENOISE`
  ☑ Convert `holeFillEnabled` to `VGE_LUMON_UPSAMPLE_HOLEFILL`
  ☑ Decide whether `holeFillRadius` becomes a define:
    - Decision: Keep as uniform. The loop uses hardcoded bounds (-8..8) with early-continue,
      so the loop structure is fixed. Changing bounds would require refactoring the loop.
  ☑ Update `LumOnUpsampleFunctionalTests`:
    - Build variants and validate behavior
    - Updated HoleFill_OnlyAffectsLowConfidenceAreas to compile two shader variants
    - Updated DenoiseDisabled_RawBilinear to use VGE_LUMON_UPSAMPLE_DENOISE=0 define

  Phase 4 outputs:
    - `assets/vanillagraphicsexpanded/shaders/lumon_upsample.fsh` (import vge_global_defines.glsl, #if branches)
    - `assets/vanillagraphicsexpanded/shaders/includes/vge_global_defines.glsl` (added UPSAMPLE defines)
    - `LumOnUpsampleShaderProgram.cs` (SetDefine wiring for bool properties)
    - `LumOnRenderer.cs` (bool-typed callers)
    - `LumOnUpsampleFunctionalTests.cs` (updated to use CompileShaderWithDefines)
    - `LumOnShaderFunctionalTestBase.cs` (added CompileShaderWithDefines helper)
    - `ShaderDefineInjectionTests.cs` (added LumOnUpsample variant compilation tests)

  Phase 5 - Convert Temporal/Reprojection Mode Toggles:
  Exit artifacts: Temporal velocity reprojection selection is a define; tests validate both modes.
  ☑ Convert `EnableReprojectionVelocity` to `VGE_LUMON_TEMPORAL_USE_VELOCITY_REPROJECTION`
  ☑ Update temporal shader(s) to compile both paths cleanly
  ☑ Update relevant GPU tests to compile both variants and validate history rejection behavior
    - LumOnTemporalFunctionalTests now compile with VGE_LUMON_TEMPORAL_USE_VELOCITY_REPROJECTION=0 (core temporal logic)
    - LumOnTemporalVelocityFunctionalTests compile with velocity enabled/disabled variants

  Phase 5 outputs:
    - `assets/vanillagraphicsexpanded/shaders/lumon_temporal.fsh` (import vge_global_defines.glsl, #if branch)
    - `assets/vanillagraphicsexpanded/shaders/includes/vge_global_defines.glsl` (added TEMPORAL define)
    - `LumOnTemporalShaderProgram.cs` (SetDefine wiring for bool property)
    - `LumOnRenderer.cs` (bool-typed caller)
    - `LumOnTemporalFunctionalTests.cs` (compile with velocity disabled)
    - `LumOnTemporalVelocityFunctionalTests.cs` (compile variants, updated helper methods)
    - `ShaderDefineInjectionTests.cs` (added LumOnTemporal variant compilation tests)

  Phase 6 - Convert Rare Loop-Bound Knobs (Optional / Careful):
  Exit artifacts: Loop-bound parameters that materially change shader structure are defines (only if we accept compile-time variants).
  ☑ Decide policy for loop-bound settings:
    - Promote to defines. Shader system recompiles on define changes, so hot-reload is preserved.
  ☑ Candidate conversions:
    - `RaysPerProbePerFrame` → `VGE_LUMON_RAYS_PER_PROBE` (SH tracer)
    - `RaySteps` → `VGE_LUMON_RAY_STEPS`
    - `ProbeAtlasTexelsPerFrame` → `VGE_LUMON_ATLAS_TEXELS_PER_FRAME`
    - `RayMaxDistance` → `VGE_LUMON_RAY_MAX_DISTANCE`
    - `RayThickness` → `VGE_LUMON_RAY_THICKNESS`
    - `SkyMissWeight` → `VGE_LUMON_SKY_MISS_WEIGHT`
    - `HzbCoarseMip` → `VGE_LUMON_HZB_COARSE_MIP`
  ☑ Update tests that currently vary these at runtime:
    - Compile multiple shader programs per setting (define injection)

  Phase 6 outputs:
    - `assets/vanillagraphicsexpanded/shaders/includes/vge_global_defines.glsl` (added loop-bound defines)
    - `assets/vanillagraphicsexpanded/shaders/lumon_probe_trace.fsh` (define-based loops)
    - `assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_trace.fsh` (define-based loops)
    - `assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_temporal.fsh` (define-based distribution)
    - `LumOnProbeTraceShaderProgram.cs` (SetDefine wiring for rays/steps/maxDistance/thickness/sky)
    - `LumOnScreenProbeAtlasTraceShaderProgram.cs` (SetDefine wiring for texels/steps/maxDistance/thickness/sky/hzb)
    - `LumOnScreenProbeAtlasTemporalShaderProgram.cs` (SetDefine wiring for texels)
    - `LumOnUniformTests.cs` (mapped loop-bound uniforms to defines)
    - `LumOnProbeTraceFunctionalTests.cs` (compile variants)
    - `LumOnProbeAtlasTraceFunctionalTests.cs` (compile variants)
    - `LumOnProbeAtlasTemporalFunctionalTests.cs` (compile variants)
    - `LumOnHzbFunctionalTests.cs` (compile variants)
    - `PbrLumOnFullPipelineIntegrationTests.cs` (define-based compilation)
    - `ShaderDefineInjectionTests.cs` (loop-bound variant compilation tests)

  Phase 7 - Refactor “Common Values” Includes:
  Exit artifacts: Shared constants/defaults live in centralized includes, reducing duplication across shaders.
  ☑ Create/extend common include files:
    - `global_defines.glsl` (defines)
    - `common_constants.glsl` (math/limits)
  ☑ Move duplicated constants out of per-pass shaders:
    - Avoid putting frequently tuned values in global includes

  Phase 7 outputs:
    - `assets/vanillagraphicsexpanded/shaders/includes/common_constants.glsl`
    - `assets/vanillagraphicsexpanded/shaders/includes/normal_smoothing.glsl` (uses shared constants)
    - `assets/vanillagraphicsexpanded/shaders/includes/pbr_common.glsl` (uses shared constants)

  Phase 8 - Cleanup + Documentation:
  Exit artifacts: Codebase is consistent; docs and tests explain how defines work.
  ☐ Create authoritative Enum for listing all VGE shader define names
  ☐ Remove obsolete uniform setters/properties from shader program wrappers
  ☐ Ensure renderers set defines before `Use()` and don’t spam recompile:
    - Only set defines when config values change (optional optimization)
  ☐ Update docs:
    - Add a short doc explaining “uniform vs define” guidelines
    - Note test strategy (define injection / compiled variants)
  ☐ Verify:
    - `dotnet test` passes
    - Shader compilation tests pass
    - Visual sanity: toggling LumOn / AO / bent normal works as expected
