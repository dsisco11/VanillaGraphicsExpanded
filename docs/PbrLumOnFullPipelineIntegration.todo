PBR + LumOn Full Pipeline GPU Integration Test (One Frame, Fixed History)

Goal:
  Add an end-to-end GPU integration test that runs the full shader pass pipeline:
    PBR Direct → LumOn Velocity → LumOn HZB → LumOn Probe Anchor → LumOn Atlas Trace →
    LumOn Atlas Temporal (fixed history) → LumOn Atlas Filter → LumOn Atlas Gather →
    LumOn Upsample → PBR Composite

Why:
  We currently have many per-pass GPU functional tests, but we lack a single test that validates:
  - real wiring between passes (texture bindings, formats, sizes)
  - intermediate outputs are non-zero/finite and flow into later stages
  - the final composite actually incorporates full-res indirect diffuse

Notes / Constraints:
  - One frame only; history textures are fixed inputs (not swapped from a previous rendered frame).
  - Determinism > photorealism: use tiny buffers (4×4 screen, 2×2 half-res, 2×2 probes, 16×16 atlas).
  - Assertions should prefer:
    - finite / not NaN
    - known monotonic/non-zero relationships
    - “baseline == direct-only” checks
    - tolerate GPU variance via epsilon (see existing TestEpsilon patterns)

Reference infrastructure:
  - Headless GL context: VanillaGraphicsExpanded.Tests/GPU/Fixtures/HeadlessGLFixture.cs
  - GPU test base + readback: VanillaGraphicsExpanded.Tests/GPU/Fixtures/RenderTestBase.cs
  - Shader compilation + test framework: VanillaGraphicsExpanded.Tests/GPU/Fixtures/LumOnShaderFunctionalTestBase.cs

Target output artifacts:
  - New test file: VanillaGraphicsExpanded.Tests/GPU/PbrLumOnFullPipelineIntegrationTests.cs
  - Test name(s): Integration_OneFrame_FullPipeline_PropagatesIndirectIntoComposite


Phase 1 - Pipeline Map + Shader Inventory
Exit artifacts: A definitive list of shader programs used + their required uniforms/samplers.
  ✔ Locate PBR shader filenames for direct lighting and composite in assets/shaders
  ✔ Locate LumOn shader filenames for velocity, HZB, anchor, atlas trace, atlas temporal, atlas filter, atlas gather, upsample
  ✔ For each shader, list:
    - required samplers (texture units + names)
    - required uniforms (screenSize, matrices, zNear/zFar, frameIndex, etc.)
    - output attachments (formats, MRT count)

  Inventory (source-of-truth from shader headers):

  PBR - Direct Lighting (MRT)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/pbr_direct_lighting.vsh
      - assets/vanillagraphicsexpanded/shaders/pbr_direct_lighting.fsh
    Outputs:
      - layout(location=0) out vec4 outDirectDiffuse
      - layout(location=1) out vec4 outDirectSpecular
      - layout(location=2) out vec4 outEmissive
    Samplers:
      - primaryScene
      - primaryDepth
      - gBufferNormal
      - gBufferMaterial
      - shadowMapNear
      - shadowMapFar
    Uniforms:
      - invProjectionMatrix, invModelViewMatrix
      - zNear, zFar
      - cameraOriginFloor, cameraOriginFrac
      - lightDirection, rgbaAmbientIn, rgbaLightIn
      - pointLightsCount, pointLights3[100], pointLightColors3[100]
      - toShadowMapSpaceMatrixNear/Far, shadowRangeNear/Far, shadowZExtendNear/Far, dropShadowIntensity

  LumOn - Velocity (MRT 1)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_velocity.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_velocity.fsh
    Outputs:
      - layout(location=0) out vec4 outVelocity  (RGBA32F expected)
    Samplers:
      - primaryDepth
    Uniforms:
      - screenSize
      - invCurrViewProjMatrix
      - prevViewProjMatrix
      - historyValid

  LumOn - HZB (Depth Pyramid)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_hzb_copy.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_hzb_copy.fsh
      - assets/vanillagraphicsexpanded/shaders/lumon_hzb_downsample.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_hzb_downsample.fsh
    Outputs:
      - hzb_copy: layout(location=0) out float outDepth  (R32F mip0)
      - hzb_downsample: layout(location=0) out float outDepth  (R32F mipN)
    Samplers:
      - hzb_copy: primaryDepth
      - hzb_downsample: hzbDepth
    Uniforms:
      - hzb_downsample: srcMip

  LumOn - Probe Anchor (MRT)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_anchor.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_anchor.fsh
    Outputs:
      - layout(location=0) out vec4 outPosition  (posWS.xyz, valid)
      - layout(location=1) out vec4 outNormal    (encoded normalWS.xyz)
    Samplers:
      - primaryDepth
      - gBufferNormal
    Uniforms:
      - invProjectionMatrix, invViewMatrix
      - probeSpacing, probeGridSize, screenSize
      - frameIndex, anchorJitterEnabled, anchorJitterScale
      - zNear, zFar
      - depthDiscontinuityThreshold

  LumOn - Probe Atlas Trace (MRT)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_trace.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_trace.fsh
    Outputs:
      - layout(location=0) out vec4 outRadiance  (RGB radiance, A hitdist encoded)
      - layout(location=1) out vec2 outMeta      (R confidence, G flags)
    Samplers:
      - probeAnchorPosition
      - probeAnchorNormal
      - primaryDepth
      - directDiffuse
      - emissive
      - hzbDepth
      - octahedralHistory
      - probeAtlasMetaHistory
    Uniforms:
      - hzbCoarseMip
      - invProjectionMatrix, projectionMatrix, viewMatrix, invViewMatrix
      - probeGridSize, screenSize
      - frameIndex, texelsPerFrame
      - raySteps, rayMaxDistance, rayThickness
      - zNear, zFar
      - skyMissWeight, sunPosition, sunColor, ambientColor
      - indirectTint

  LumOn - Probe Atlas Temporal (MRT)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_temporal.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_temporal.fsh
    Outputs:
      - layout(location=0) out vec4 outRadiance
      - layout(location=1) out vec2 outMeta
    Samplers:
      - octahedralCurrent
      - probeAtlasMetaCurrent
      - probeAtlasMetaHistory
      - octahedralHistory
      - probeAnchorPosition
    Uniforms:
      - probeGridSize
      - frameIndex, texelsPerFrame
      - temporalAlpha
      - hitDistanceRejectThreshold

  LumOn - Probe Atlas Filter (MRT)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_filter.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_filter.fsh
    Outputs:
      - layout(location=0) out vec4 outRadiance
      - layout(location=1) out vec2 outMeta
    Samplers:
      - octahedralAtlas
      - probeAtlasMeta
      - probeAnchorPosition
    Uniforms:
      - probeGridSize
      - filterRadius
      - hitDistanceSigma

  LumOn - Probe Atlas Gather (Half-Res)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_gather.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_probe_atlas_gather.fsh
    Outputs:
      - out vec4 outColor  (RGB irradiance, A diagnostics/weight)
    Samplers:
      - octahedralAtlas
      - probeAnchorPosition
      - probeAnchorNormal
      - primaryDepth
      - gBufferNormal
    Uniforms:
      - invProjectionMatrix, viewMatrix
      - probeSpacing, probeGridSize, screenSize, halfResSize
      - zNear, zFar
      - intensity, indirectTint
      - leakThreshold
      - sampleStride

  LumOn - Upsample (Full-Res)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/lumon_upsample.vsh
      - assets/vanillagraphicsexpanded/shaders/lumon_upsample.fsh
    Outputs:
      - out vec4 outColor  (RGB indirect full-res)
    Samplers:
      - indirectHalf
      - primaryDepth
      - gBufferNormal
    Uniforms:
      - screenSize, halfResSize
      - zNear, zFar
      - denoiseEnabled, upsampleDepthSigma, upsampleNormalSigma, upsampleSpatialSigma
      - holeFillEnabled, holeFillRadius, holeFillMinConfidence

  PBR - Composite (Final Merge)
    Shaders:
      - assets/vanillagraphicsexpanded/shaders/pbr_composite.vsh
      - assets/vanillagraphicsexpanded/shaders/pbr_composite.fsh
    Outputs:
      - out vec4 outColor
    Samplers:
      - directDiffuse
      - directSpecular
      - emissive
      - indirectDiffuse
      - gBufferAlbedo
      - gBufferMaterial
      - gBufferNormal
      - primaryDepth
    Uniforms:
      - rgbaFogIn, fogDensityIn, fogMinIn
      - indirectIntensity, indirectTint, lumOnEnabled
      - enablePbrComposite, enableAO, enableBentNormal, diffuseAOStrength, specularAOStrength
      - invProjectionMatrix, viewMatrix


Phase 2 - Add Missing GPU Shader Coverage (Only If Needed)
Exit artifacts: All required shaders compile/link in the test harness.
  ✔ If no existing helper exists, add compile helpers for:
    - pbr_direct_lighting
    - pbr_composite
    Notes:
      - Added shared helper: VanillaGraphicsExpanded.Tests/GPU/Helpers/PbrShaderPrograms.cs
      - Uses the same inline vertex shader approach as existing GPU tests (matches test quad layout)
  ✔ Add a quick “shader compiles and links” smoke test if any program fails to compile
    Notes:
      - Not required right now: PBR compile/link is already exercised by VanillaGraphicsExpanded.Tests/GPU/PbrDirectLightingFunctionalTests.cs


Phase 3 - Deterministic Input Scene Setup
Exit artifacts: Reusable deterministic textures for the entire pipeline.
  ✔ Create deterministic primary inputs:
    - primarySceneColor (RGBA16F): constant mid-gray
    - primaryDepth (R32F): constant depth (avoid sky behavior unless explicitly tested)
    - gBufferNormal (RGBA16F): constant +Z normal (encoded)
    - gBufferMaterial (RGBA16F): choose roughness/metallic/emissive/reflectivity constants
    - gBufferAlbedo (RGBA16F): constant or simple 2-color pattern
    Notes:
      - Added helper: VanillaGraphicsExpanded.Tests/GPU/Helpers/PbrLumOnPipelineInputFactory.cs
      - Encodes normals to [0,1] to match lumonDecodeNormal + direct lighting decode
      - gBufferMaterial layout matches pbr_direct_lighting.fsh: R=roughness, G=metallic, B=emissiveScalar, A=reflectivity
      - Recommended baseline values for the integration test:
        - primaryDepth=0.5 (non-sky, stable)
        - normalWS=(0,0,1) encoded
        - material=(roughness=0.5, metallic=0.0, emissive=0.0, reflectivity=1.0)
        - albedo/baseColor=(0.6, 0.4, 0.2)
  ✔ Create deterministic history inputs for temporal:
    - atlasHistoryRadiance (RGBA16F): uniform low value
    - atlasHistoryMeta (RG32F): uniform confidence/flags
    - radianceHistory (if SH path is touched): uniform
    Notes:
      - RG32F meta history generator writes (confidence, uintBitsToFloat(flags))
      - For one-frame deterministic runs, recommended metaHistory confidence is 0.0 so temporal chooses current
      - radianceHistory (SH) is intentionally omitted for the atlas-gather path
  ✔ Lock down fixed matrices:
    - view / invProjection (identity or the existing deterministic matrices used in other tests)
    Notes:
      - Use identity view + realistic projection/invProjection from LumOnTestInputFactory
      - Velocity uses invCurrViewProjMatrix=invProjection and prevViewProjMatrix=projection for zero motion


Phase 4 - Allocate Intermediate Render Targets (Match Production)
Exit artifacts: Every pass has an explicitly owned RT with correct size/format.
  ✔ Allocate PBR Direct MRT outputs:
    - directDiffuse, directSpecular, emissive (RGBA16F)
  ✔ Allocate velocity (RGBA32F)
  ✔ Allocate HZB depth pyramid (R32F mip chain) + FBO for downsample writes
  ✔ Allocate probe anchor outputs:
    - probeAnchorPosition (RGBA16F)
    - probeAnchorNormal (RGBA16F)
  ✔ Allocate atlas outputs:
    - atlasTraceRadiance (RGBA16F)
    - atlasTraceMeta (RG32F)
    - atlasCurrentRadiance (RGBA16F)
    - atlasCurrentMeta (RG32F)
    - atlasFilteredRadiance (RGBA16F)
    - atlasFilteredMeta (RG32F) (if used)
  ✔ Allocate gather output:
    - indirectHalf (RGBA16F, half-res)
  ✔ Allocate upsample output:
    - indirectFull (RGBA16F, full-res)
  ✔ Allocate final composite output RT (RGBA16F)
    Notes:
      - Added allocators:
        - VanillaGraphicsExpanded.Tests/GPU/Helpers/PbrLumOnPipelineTargets.cs
        - VanillaGraphicsExpanded.Tests/GPU/Helpers/HzbTestPyramid.cs
      - Sizes follow the spec: 4×4 screen, 2×2 half-res, 2×2 probe grid, 16×16 atlas


Phase 5 - Execute Full Pipeline (One Frame)
Exit artifacts: Single test runs passes in-order and validates each stage.
  ✔ Run PBR Direct → write MRT
    - Assert: directDiffuse not all zeros; emissive behaves as expected for emissiveScalar
  ✔ Run LumOn Velocity
    - Assert: velocity finite; with fixed matrices expect near-zero velocity everywhere
  ✔ Run LumOn HZB build
    - Assert: mip0 equals input depth; higher mips monotonic (as per existing HZB tests)
  ✔ Run LumOn Probe Anchor
    - Assert: anchor validity not all zeros; position/normal finite
  ✔ Run LumOn Atlas Trace
    - Assert: trace radiance finite; meta confidence in [0,1]
  ✔ Run LumOn Atlas Temporal (fixed history)
    - Assert: current differs from history when trace indicates valid; otherwise preserves history
  ✔ Run LumOn Atlas Filter
    - Assert: filtered output finite; does not introduce NaNs
  ✔ Run LumOn Atlas Gather
    - Assert: indirectHalf finite and non-zero (for a non-sky test depth)
  ✔ Run LumOn Upsample
    - Assert: indirectFull finite and non-zero at representative pixels
  ✔ Run PBR Composite
    - Assert: composite != direct-only baseline when indirect is enabled
    Notes:
      - Added end-to-end test: VanillaGraphicsExpanded.Tests/GPU/PbrLumOnFullPipelineIntegrationTests.cs
      - Uses Phase 3 deterministic inputs + Phase 4 targets allocators


Phase 6 - Assertions That Pinpoint Where It Breaks
Exit artifacts: Failures identify the first broken stage with clear messages.
  ✔ Add per-stage “checkpoint” asserts with labeled failure messages:
    - e.g., "Stage: Upsample → IndirectFull unexpectedly zero"
  ✔ Add a direct-only baseline path:
    - run composite with indirectFull bound to zeros (or indirect disabled uniform)
    - assert baseline matches expected direct output within epsilon
  ✔ Add an indirect-injected sanity path:
    - bypass LumOn, bind a known constant indirectFull texture
    - assert composite brightens as expected (proves composite binding logic)
    Notes:
      - Implemented in VanillaGraphicsExpanded.Tests/GPU/PbrLumOnFullPipelineIntegrationTests.cs


Phase 7 - Test Hygiene + Reliability
Exit artifacts: Stable local runs; safe defaults for CI.
  ✔ Ensure the test is [Collection("GPU")] and [Trait("Category","GPU")]
  ✔ Use existing GPU skip patterns (if present) to avoid CI hard failures
  ✔ Keep resolution tiny to minimize runtime
  ✔ Ensure all GL resources are disposed/deleted to prevent cross-test leakage
    Notes:
      - Integration test uses EnsureShaderTestAvailable() (HeadlessGLFixture + shader-path skips)
      - Added AssertNoGLError checkpoints in the integration test to prevent queued GL errors leaking into subsequent GPU tests


Phase 8 - Optional Follow-ups (If the bug persists)
Exit artifacts: Additional debug outputs to shorten future iterations.
  ☐ On failure, dump 1–4 pixel samples per stage to test output (not full textures)
  ☐ Add a debug mode to visualize indirectFull binding in composite shader (if cheap)
  ☐ Add a second integration test for the SH9 projection path (optional)
