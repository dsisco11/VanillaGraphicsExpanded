# Material System Disk Cache Plan
See: `docs/MaterialSystem.Cache.Architecture.md`

Goal: Add a disk cache for material params, normal, and depth bake outputs.
Scope: Per-texture-rect caching for block atlas pages (RGBA16_UNORM payload; RGB stored in RGBA with A=1 for material params).
Non-goals: Changes to mapping rules, shader formats, or engine API behavior.

---

## Phase 0 - Requirements and Policy
Exit artifacts: clear cache policy and terminology.
- [x] Global cache by default with per-world overlay for mutable/unknown assets.
- [x] Stable vs mutable provenance: base/mod without pack override = stable; pack/server/world override or unknown = mutable.
- [x] Unknown provenance defaults to per-world only.
- [x] Cache root: `VintagestoryData/VGE/Cache/` with per-world `Worlds/<worldId>/` overlay.
- [x] Add config toggle: enable cache (default: true). See `docs/MaterialSystem.Cache.Architecture.md`.

---

## Phase 1 - Cache Key and Fingerprint Schema
Exit artifacts: versioned key spec and metadata contract.
- [x] Cache key fields for material params (asset location, rect size, resolved params, noise, scale, overrides). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Cache key fields for normal+depth (config values, normal/depth scale, source asset fingerprint). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Lightweight fingerprints (path, source id, last modified, size, pack/mod list fingerprints). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Bake-version stamp (blue-noise seed/size, algorithm constants, schema version). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Document key serialization order and hashing method. See `docs/MaterialSystem.Cache.Architecture.md`.

---

## Phase 2 - Disk Cache Storage
Exit artifacts: cache reader/writer with safe persistence.
- [x] Implement `MaterialAtlasDiskCache` (read/write, versioned header).
- [x] File layout: per-tile `.dds` payload + `.meta` sidecar. See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Add atomic writes (temp file then move) and corruption handling. See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Track last-access timestamps for eviction.
- [x] Enforce max size and prune least-recently-used entries.

---

## Phase 3 - Material Params Integration
Exit artifacts: cache hit path for RGB rects.
- [x] Cache lookup per tile job (skip CPU compute on hit). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Upload cached data directly via render thread.
- [x] Cache post-override results (so a hit skips override stage).
- [x] Ensure session generation id protects against stale cache work.
- [x] Wire sync build path to use cache too.

---

## Phase 4 - Normal+Depth Integration
Exit artifacts: cache hit path for RGBA rects.
- [x] Add per-tile cache lookup before GPU bake. See `docs/MaterialSystem.Cache.Architecture.md`.
- [ ] Upload cached rects and bake only misses per page.
- [x] Read back baked misses per tile. See `docs/MaterialSystem.Cache.Architecture.md`.
- [ ] Cache normal+height override outputs as authoritative.
- [ ] Ensure bake clear and override order remains deterministic.

---

## Phase 5 - Invalidation and Provenance
Exit artifacts: stable invalidation rules.
- [x] Global cache namespace fingerprint (mod list + resource packs). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Per-world namespace fingerprint (world id + server mods/packs). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Invalidate on material_definitions changes (timestamp or version). See `docs/MaterialSystem.Cache.Architecture.md`.
- [x] Guard against dimension mismatch and reject stale cache entries. See `docs/MaterialSystem.Cache.Architecture.md`.
- [ ] Provide manual cache clear hook for debugging.

---

## Phase 6 - Diagnostics and Validation
Exit artifacts: visibility into cache behavior and correctness.
- [ ] Log hit/miss stats (per system and per asset class).
- [ ] Expose counters (entries, bytes, evictions).
- [ ] Add tests for key stability and fingerprint changes.
- [ ] Validate parity between cached and freshly baked outputs.
- [ ] Add performance notes (readback cost vs bake cost).
