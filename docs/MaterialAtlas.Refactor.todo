# PBR Material Atlas Refactor Plan

Goal: Split the current PBR material atlas system into cleanly separated systems for
- async/iterative processing
- DynamicTexture production and ownership
- GPU execution (shader/compute)
- disk caching (load/save, skip recompute)

Scope: Material params atlas (RGB16F) and normal+depth atlas (RGBA16F) for block atlas pages.
Non-goals: New material mapping rules, shader format changes, or engine API changes.

---

## Phase 0 - Inventory and Baseline
Exit artifacts: current responsibilities and seams documented; parity baseline.
- [x] Capture current entry points and lifecycle (BlockTexturesLoaded, ReloadTextures).
- [x] Note which calls are GL/render-thread only vs CPU-safe.
- [x] Identify duplicated atlas page/rect math and override loading paths.
- [x] Record baseline metrics (pages, rects, overrides, build duration). (skipped per request)
- [x] Confirm existing tests and add missing coverage targets.

### Phase 0 Notes

Entry points and lifecycle:
- `VanillaGraphicsExpanded/VanillaGraphicsExpandedModSystem.cs`: StartClientSide -> `CreateTextureObjects`; BlockTexturesLoaded -> `PopulateAtlasContents`; ReloadTextures -> `RequestRebuild`.
- `VanillaGraphicsExpanded/PBR/Materials/PbrMaterialAtlasTextures.cs`: `Initialize` wrapper; `RebakeNormalDepthAtlas` exists but is not wired to events.
- `VanillaGraphicsExpanded/HarmonyPatches/TerrainMaterialParamsTextureBindingHook.cs`: binds the per-page textures on terrain shader set.

GL vs CPU-only:
- GL-only: `VanillaGraphicsExpanded/Rendering/DynamicTexture.cs` (all texture ops), `VanillaGraphicsExpanded/PBR/Materials/PbrNormalDepthAtlasGpuBaker.cs` (FBO/shader pipeline), render-thread uploads in `VanillaGraphicsExpanded/PBR/Materials/Async/PbrMaterialAtlasBuildScheduler.cs`.
- CPU-safe: `VanillaGraphicsExpanded/PBR/Materials/PbrMaterialParamsPixelBuilder.cs` (tile generation), `VanillaGraphicsExpanded/PBR/Materials/PbrMaterialParamsOverrideApplier.cs`.
- Treat as main-thread: `VanillaGraphicsExpanded/PBR/Materials/PbrOverrideTextureLoader.cs` (uses `capi.Assets` + `BitmapRef`) until proven safe.

Duplication hotspots:
- Atlas page enumeration is repeated in `PbrMaterialAtlasTextures.CreateTextureObjects`, `PopulateAtlasContents`, and `RebakeNormalDepthAtlas`.
- Rect conversion (UV -> pixel bounds) repeats in `PopulateAtlasContents`, `StartMaterialParamsAsyncBuild`, `PopulateMaterialParamsSync`, and normal/depth override scanning.
- Override loading + apply path duplicated between sync (`PopulateMaterialParamsSync`) and async (`PbrMaterialAtlasBuildScheduler`) flows.
- Normal/depth bake logic duplicated between `PopulateAtlasContents` and `RebakeNormalDepthAtlas`.

Baseline metrics:
- Skipped per request.

Existing tests and gaps:
- Existing: `VanillaGraphicsExpanded.Tests/Unit/PBR/Materials/PbrMaterialAtlasPositionResolverTests.cs`,
  `VanillaGraphicsExpanded.Tests/Unit/PBR/Materials/PbrMaterialParamsPixelBuilderTests.cs`,
  `VanillaGraphicsExpanded.Tests/Unit/PBR/Materials/PbrMaterialParamsOverrideApplierTests.cs`,
  `VanillaGraphicsExpanded.Tests/GPU/PbrMaterialAtlasTexturesBuildTests.cs`,
  `VanillaGraphicsExpanded.Tests/GPU/PbrNormalDepthBakeShaderPipelineTests.cs`,
  `VanillaGraphicsExpanded.Tests/GPU/PbrMaterialParamsTextureSmokeTests.cs`,
  `VanillaGraphicsExpanded.Tests/GPU/DynamicTextureReadPixelsTests.cs`.
- Gaps: async scheduler cancellation/progress; override loader caching and DDS decode; normal/depth per-tile bounds and override application; planner determinism; cache key stability.

---

## Phase 1 - Data Contracts and Atlas Snapshot
Exit artifacts: shared data structures that decouple planning from execution.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Define `AtlasSnapshot` (pages, sizes, positions, reload iteration, non-null count).
- [x] Define `AtlasRect` + `AtlasRectResolver` for UV->pixel conversion with clamping rules.
- [x] Define `AtlasBuildPlan` (per-page jobs, overrides, stats).
- [x] Define `AtlasCacheKey` (hash of inputs, versioned schema).
- [x] Centralize atlas position normalization (replace inline copies).

---

## Phase 2 - Texture Store (DynamicTexture Ownership)
Exit artifacts: a dedicated store for page textures and lifecycle management.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Create `MaterialAtlasTextureStore` to allocate/resize/dispose per atlas page.
- [x] Expose lookups for material params and normal+depth texture IDs.
- [x] Move default fill/placeholder creation into the store.
- [x] Replace direct dictionary access in `MaterialAtlasSystem`.

---

## Phase 3 - Build Planning (Registry + Atlas)
Exit artifacts: pure planning layer that produces jobs from registry + atlas snapshot.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Create `MaterialAtlasBuildPlanner` that consumes snapshot + registry.
- [x] Produce per-rect material params jobs and optional override jobs.
- [x] Produce per-rect normal+depth bake jobs + overrides.
- [x] Isolate asset scans (textures/block) behind a planner helper.
- [x] Ensure planner is deterministic and side-effect free.

---

## Phase 4 - Material Params Pipeline (CPU + Upload)
Exit artifacts: single pipeline used by both sync and async paths.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Extract `MaterialAtlasParamsBuilder` from `PbrMaterialParamsPixelBuilder`.
- [x] Create `MaterialOverrideTextureLoader` (wraps `PbrOverrideTextureLoader`).
- [x] Define `MaterialAtlasParamsUploader` (uploads per tile to texture store).
- [x] Route sync path through the same pipeline used by async jobs.
- [x] Add unit tests for per-rect generation and override application.

---

## Phase 5 - Normal+Depth Pipeline (GPU + Overrides)
Exit artifacts: planner + GPU runner split; unified re-bake flow.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Create `MaterialAtlasNormalDepthBuildPlanner` to define per-tile GPU tasks.
- [x] Wrap `PbrNormalDepthAtlasGpuBaker` in a `MaterialAtlasNormalDepthBuildRunner`.
- [x] Add override apply stage after bake (reuse loader/provider).
- [x] Route `RebakeNormalDepthAtlas` through the same pipeline.
- [x] Confirm all GL calls are render-thread only.

---

## Phase 6 - Async/Iterative Scheduler Integration
Exit artifacts: scheduler runs on shared job interfaces and supports sync fallback.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Define job interfaces/records for CPU work and GPU uploads.
- [x] Adapt `MaterialAtlasBuildScheduler` to new job types.
- [x] Keep generation-id cancellation and stale job drop behavior.
- [x] Expose progress counters for pages, jobs, overrides.
- [x] Ensure sync path can reuse the same build plan.

---

## Phase 7 - Disk Cache Subsystem
Exit artifacts: cache interfaces and wiring points only (no persistence).
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Define cache interfaces (lookup/store/invalidate) and data contracts.
- [x] Define cache key builder inputs (snapshot + registry + config).
- [x] Add no-op cache implementation and wire it through the pipeline.
- [x] Add config toggles and logging stubs for cache integration points
- [x] Defer persistence and eviction policy to `MaterialSystem.Cache.todo`.

---

## Phase 8 - Orchestration and Events
Exit artifacts: a thin orchestrator that delegates to planner/pipelines/stores.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [x] Introduce `MaterialAtlasSystem` (or rename existing class).
- [x] Wire events in `VanillaGraphicsExpandedModSystem` to orchestrator.
- [x] Update `TerrainMaterialParamsTextureBindingHook` to query texture store.
- [x] Ensure clean shutdown: cancel sessions, dispose textures, clear caches.

---

## Phase 9 - Diagnostics, UX, and Validation
Exit artifacts: observability and test coverage for the refactor.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [ ] Add progress metrics for async builds (queue lengths, ms per frame).
- [ ] Create a new "task progress" notification panel for UX which shows atlas build status.
- [ ] Add tests for planner determinism and cache key stability.

---

## Rename Checklist (System/Tile/Build, drop Pbr prefix)
Exit artifacts: all class/file names updated and references corrected.
- Reference: `docs/MaterialAtlas.Architecture.md`
- [ ] `PbrMaterialAtlasTextures` -> `MaterialAtlasSystem`
- [ ] `PbrMaterialAtlasPositionResolver` -> `MaterialAtlasKeyResolver`
- [ ] `PbrMaterialAtlasPageTextures` -> `MaterialAtlasPageTextures`
- [ ] `PbrMaterialAtlasBuildSession` -> `MaterialAtlasBuildSession`
- [ ] `PbrMaterialAtlasBuildScheduler` -> `MaterialAtlasBuildScheduler`
- [ ] `PbrMaterialAtlasBuildSchedulerRenderer` -> `MaterialAtlasBuildSchedulerRenderer`
- [ ] `PbrMaterialAtlasTileJob` -> `MaterialAtlasTileJob`
- [ ] `PbrMaterialAtlasTileUpload` -> `MaterialAtlasTileUpload`
- [ ] `PbrMaterialAtlasMaterialOverrideUpload` -> `MaterialAtlasOverrideUpload`
- [ ] `PbrMaterialAtlasPageBuildState` -> `MaterialAtlasBuildPageState`
- [ ] `PbrMaterialParamsPixelBuilder` -> `MaterialAtlasParamsBuilder`
- [ ] `PbrMaterialParamsOverrideApplier` -> `MaterialAtlasParamsOverrideApplier`
- [ ] `PbrOverrideTextureLoader` -> `MaterialOverrideTextureLoader`
- [ ] `PbrNormalDepthAtlasGpuBaker` -> `MaterialAtlasNormalDepthGpuBuilder`
- [ ] Update file names to match class names where applicable.
- [ ] Update tests and TODO/docs references to the new names.
